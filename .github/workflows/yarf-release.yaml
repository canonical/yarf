name: Generate Changelog and Create Release

on:
  # Delete when merge
  pull_request:
    branches:
      - main
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          # Un comment when merge
          # ref: main
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Resolve tags
        id: tags
        run: bash .github/scripts/yarf-release/resolve_git_tags.sh

      - name: Collect commits between tags
        id: commits
        env:
          GH_TOKEN:  ${{ github.token }}
          FROM_KIND: ${{ steps.tags.outputs.from_kind }}
          FROM:      ${{ steps.tags.outputs.from }}
          TO:        ${{ steps.tags.outputs.to }}
        run: bash .github/scripts/yarf-release/collect_commits.sh

      - name: Build release notes body
        id: body
        env:
          FROM_KIND:   ${{ steps.tags.outputs.from_kind }}
          FROM:        ${{ steps.tags.outputs.from }}
          TO:          ${{ steps.tags.outputs.to }}
        run: bash .github/scripts/yarf-release/build_release_notes_body.sh

      - name: Write release body to job summary
        run: |
          {
            echo "## Release Notes Preview"
            echo
            echo "**From:** ${{ steps.body.outputs.note_from }}  "
            echo "**To:** \`${{ steps.tags.outputs.to }}\`"
            echo
            cat ${{ steps.body.outputs.path }}
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tags.outputs.to }}"
          NOTES_FILE="${{ steps.body.outputs.path }}"
          # gh release create "${TAG}" --title "${TAG}" --notes-file "${NOTES_FILE}" || \
          # gh release edit   "${TAG}" --notes-file "${NOTES_FILE}"
