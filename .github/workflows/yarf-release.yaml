name: Generate Changelog and Create Release

on:
  # Delete when merge
  pull_request:
    branches:
      - main
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  release:
    name: Generate Changelog and Create Release
    runs-on: ubuntu-latest
    permissions:
      # This permission is required to:
      # 1. Create the GitHub Release
      # 2. Upload release assets (if any)
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          # Un comment when merge
          # ref: main
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Resolve tags
        id: tags
        run: bash .github/scripts/yarf-release/resolve_git_tags.sh

      - name: Collect commits between tags
        id: commits
        env:
          GH_TOKEN:  ${{ github.token }}
          FROM_KIND: ${{ steps.tags.outputs.from_kind }}
          FROM:      ${{ steps.tags.outputs.from }}
          TO:        ${{ steps.tags.outputs.to }}
        run: bash .github/scripts/yarf-release/collect_commits.sh

      - name: Build release notes body
        id: body
        env:
          FROM_KIND:   ${{ steps.tags.outputs.from_kind }}
          FROM:        ${{ steps.tags.outputs.from }}
          TO:          ${{ steps.tags.outputs.to }}
        run: bash .github/scripts/yarf-release/build_release_notes_body.sh

      - name: Write release body to job summary
        env:
          NOTE_FROM:  ${{ steps.body.outputs.note_from }}
          TO:         ${{ steps.tags.outputs.to }}
          BODY_FILE:       ${{ steps.body.outputs.path }}
        run: |
          {
            echo "## Release Notes Preview"
            echo
            echo "**From:** \`${NOTE_FROM}\`"
            echo "**To:** \`${TO}\`"
            echo
            cat ${BODY_FILE}
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create or update GitHub Release
        env:
          GH_TOKEN:   ${{ github.token }}
          TAG:        ${{ steps.tags.outputs.to }}
          NOTES_FILE: ${{ steps.body.outputs.path }}
        run: |
          gh release create "${TAG}" --title "${TAG}" --notes-file "${NOTES_FILE}" || \
          gh release edit   "${TAG}" --notes-file "${NOTES_FILE}"
