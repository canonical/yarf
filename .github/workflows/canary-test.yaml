name: Canary test

on:
  workflow_call:
    inputs:
      TRACK:
        description: 'YARF track to promote within (e.g., latest)'
        type: string
        required: true
      CHANNEL:
        description: 'YARF channel to promote from (e.g., stable, candidate, beta, edge)'
        type: string
        required: true
      VER:
        description: 'The version of YARF'
        type: string
        required: true
      ARCH:
        description: 'The architecture of the snap to promote (e.g., amd64, arm64)'
        type: string
        required: true
      RUNNER:
        description: 'The type of machine to run the canary test on'
        type: string
        required: true

    outputs:
      passed:
        description: 'Whether all matrix canary tests passed'
        value: ${{ jobs.summarize.outputs.passed }}

# Read-only access to repository contents for checking out code and uploading test results
permissions:
  contents: read
  actions: read   # Required to read workflow run data

concurrency:
  group: canary-test-${{ github.ref }}-${{ inputs.TRACK }}-${{ inputs.CHANNEL }}-${{ inputs.ARCH }}
  cancel-in-progress: true

jobs:
  canary-test:
    name: ${{ matrix.platform }} - Canary test yarf snap at channel ${{ inputs.TRACK }}/${{ inputs.CHANNEL }}
    runs-on: ${{ inputs.RUNNER }}
    strategy:
      fail-fast: false
      matrix:
        platform: [Vnc, Mir]

    env:
      TEST_SUITE_PATH: tests
      EXAMPLE_PATH: examples
      GITHUB_WORKFLOWS: .github

    steps:
      - name: Install workflow dependencies
        shell: bash
        run: |
          sudo apt update -qq
          sudo apt install -y \
            git-lfs \
            jq

          pip install check-jsonschema

      - name: Check out tests
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          lfs: true
          fetch-depth: 1
          persist-credentials: false
          sparse-checkout: |
            ${{ env.TEST_SUITE_PATH }}
            ${{ env.EXAMPLE_PATH }}
            ${{ env.GITHUB_WORKFLOWS }}
          sparse-checkout-cone-mode: false

      - name: Install YARF from channel
        shell: bash
        env:
          TRACK: ${{ inputs.TRACK }}
          CHANNEL: ${{ inputs.CHANNEL }}
          SNAP_USER_COMMON: /root/snap/yarf/common
        run: |
          set -euo pipefail
          sudo snap install yarf --channel="${TRACK}/${CHANNEL}"
          sudo mkdir --parents ${SNAP_USER_COMMON}

      - name: Install platform ${{ matrix.platform }} dependencies
        shell: bash
        env:
          PLATFORM: ${{ matrix.platform }}
        run: bash .github/scripts/canary-test/install-platform-dependencies.sh "${PLATFORM}"

      - name: Run canary test
        id: test
        shell: bash
        env:
          PLATFORM: ${{ matrix.platform }}
          WAYLAND_DISPLAY: wayland-99
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
        run: |
          bash .github/scripts/canary-test/prepare-platform.sh "${PLATFORM}" "${WAYLAND_DISPLAY}"

          # Avoid GNOME apps waiting for portals
          dbus-run-session -- gnome-calculator &

          snap run yarf --platform="${PLATFORM}" --output-format=TestSubmissionSchema "${TEST_SUITE_PATH}/canary_test"

      - name: Download test submission schema and validate
        run: |
          version=$(jq -r '.version' ~/snap/yarf/common/yarf-outdir/TestSubmissionSchema_output.json)
          check-jsonschema --schemafile https://raw.githubusercontent.com/canonical/test-submission-schema/refs/heads/main/test_submission_schema/schemas/v${version}.json ~/snap/yarf/common/yarf-outdir/TestSubmissionSchema_output.json

      - name: Pin YARF to the requested version in pyproject.toml
        run: bash .github/scripts/canary-test/pin-yarf-version.sh

      - name: Build yarf-example-plugin snap
        uses: snapcore/action-build@3bdaa03e1ba6bf59a65f84a751d943d549a54e79
        with:
          path: examples/yarf-example-plugin

      - name: Install yarf-example-plugin snap
        shell: bash
        run: |
          set -euo pipefail
          sudo snap install examples/yarf-example-plugin/*.snap --dangerous

      - name: Connect platform plugin interface
        run: |
          sudo snap connect yarf-example-plugin:platform-plugins yarf:platform-plugins

      - name: Run plugin tests
        run: |
          snap run yarf --platform Example tests/plugin_suite

      - name: Run Keyword tests - VideoInput imaging
        env:
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
        run: |
          export WAYLAND_DISPLAY=wayland-1

          # Start Mir on a virtual display (doesn't require graphics hardware)
          mir-test-tools.demo-server \
            --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
            --platform-display-libs mir:virtual \
            --virtual-output 1280x1024 &

          # Wait for the compositor to start
          inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-1\$" $XDG_RUNTIME_DIR

          # Avoid GNOME apps waiting for portals
          dbus-run-session -- gnome-calculator &

          snap run yarf --platform Mir ${TEST_SUITE_PATH}/keyword_suite -- --suite video_image_test

      - name: Run Keyword tests - VideoInput text
        env:
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
        run: |
          export WAYLAND_DISPLAY=wayland-2

          # Start Mir on a virtual display (doesn't require graphics hardware)
          mir-test-tools.demo-server \
            --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
            --platform-display-libs mir:virtual \
            --virtual-output 1280x1024 &

          # Wait for the compositor to start
          inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-2\$" $XDG_RUNTIME_DIR

          # Avoid GNOME apps waiting for portals
          dbus-run-session -- eog -f ${TEST_SUITE_PATH}/keyword_suite/text/text.png &

          snap run yarf --platform Mir ${TEST_SUITE_PATH}/keyword_suite -- --suite video_text_test

      - name: Run Keyword tests - Hid keyboard
        env:
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
          SNAP_USER_COMMON: /root/snap/yarf/common
        run: |
          export WAYLAND_DISPLAY=wayland-3
          export WAYLAND_DEBUG=client

          # Start Mir on a virtual display (doesn't require graphics hardware)
          mir-test-tools.demo-server \
            --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
            --platform-display-libs mir:virtual \
            --virtual-output 1280x1024 &

          # Wait for the compositor to start
          inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-3\$" $XDG_RUNTIME_DIR

          sudo snap run yarf --platform Mir ${TEST_SUITE_PATH}/keyword_suite -- --suite hid_keyboard_test 2> ${SNAP_USER_COMMON}/wayland.trace

      - name: Run Keyword tests - Hid pointer
        env:
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
          SNAP_USER_COMMON: /root/snap/yarf/common
        run: |
          export WAYLAND_DISPLAY=wayland-4
          export WAYLAND_DEBUG=client

          # Start Mir on a virtual display (doesn't require graphics hardware)
          mir-test-tools.demo-server \
            --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
            --platform-display-libs mir:virtual \
            --virtual-output 1280x1024 &

          # Wait for the compositor to start
          inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-4\$" $XDG_RUNTIME_DIR

          sudo snap run yarf --platform Mir ${TEST_SUITE_PATH}/keyword_suite -- --suite hid_pointer_test 2> ${SNAP_USER_COMMON}/wayland.trace

      - name: Run Keyword tests - KVM
        env:
          TEST_SUITE_PATH: ${{ env.TEST_SUITE_PATH }}
        run: |
          export WAYLAND_DISPLAY=wayland-5
          export WAYLAND_DEBUG=client

          # Start Mir on a virtual display (doesn't require graphics hardware)
          mir-test-tools.demo-server \
            --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
            --platform-display-libs mir:virtual \
            --virtual-output 1280x1024 &

          # Wait for the compositor to start
          inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-5\$" $XDG_RUNTIME_DIR

          dbus-run-session -- gnome-calculator &

          snap run yarf --platform Mir ${TEST_SUITE_PATH}/keyword_suite -- --suite kvm_test

      - if: failure()
        name: Collect test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: yarf-canary-output-${{ matrix.platform }}-${{ inputs.ARCH }}
          path: ~/snap/yarf/common/yarf-outdir/*
          retention-days: 5

      - if: failure() && runner.debug
        name: Setup upterm session (restart with "Enable debug logging" to activate)
        uses: canonical/action-tmate@a0e8caed3bba2ccb98901a274553bf1284ad96c2  # zizmor: ignore[stale-action-refs]
        with:
          limit-access-to-actor: true

  summarize:
    name: Summarize test results
    needs: canary-test
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.set.outputs.passed }}
    steps:
      - id: set
        env:
          CANARY_TEST_RESULT: ${{ needs.canary-test.result }}
        run: |
          if [[ "${CANARY_TEST_RESULT}" == "success" ]]; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
          fi
