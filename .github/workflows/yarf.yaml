name: Testing and quality control for YARF codebase

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    paths:
      - '**'
      - '!docs/**'
      - '!snap/**'
      - '!.github/workflows/*'
      - '.github/workflows/yarf.yaml'

permissions:
  contents: read  # Required to check out repository code

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install-jammy:
    name: Install and test on Jammy
    runs-on: [self-hosted, linux, jammy, x64, large]
    steps:
    - name: Install dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y \
          git-lfs \
          libgl1 \
          libxkbcommon-dev \
          jq \
          clang \
          python3-tk

    - name: Checkout Repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        lfs: true
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
      with:
        python-version: "3.10"
    - name: Install uv
      run: pip install uv
    - name: Sync Python dependencies
      run: uv sync

  test-noble:
    name: Test on Noble
    # We use GitHub hosted runners for this job as Pa11y needs working Chrom support
    runs-on: ubuntu-24.04
    steps:
    - name: Install dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y \
          git-lfs \
          libgl1 \
          libxkbcommon-dev \
          jq \
          clang \
          python3-tk \
          tesseract-ocr

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        lfs: true
        fetch-depth: 0
        persist-credentials: false
    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
      with:
        python-version: "3.12"

    - name: Install uv and json schema
      run: pip install uv check-jsonschema

    - name: Check uv.lock file
      run: uv lock --check

    - name: Run tests
      run: |
        uv tool run tox

    - name: Upload Coverage Report
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: coverage
        path: ./coverage.xml
        retention-days: 5

    - name: Install integration dependencies
      run: |
        sudo snap install mir-test-tools
        sudo apt-get --yes --no-install-recommends install \
          ffmpeg \
          inotify-tools \
          gnome-calculator

    - name: Run integration tests
      run: |
        export WAYLAND_DISPLAY=wayland-99

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-99\$" $XDG_RUNTIME_DIR

        # Avoid GNOME apps waiting for portals
        dbus-run-session -- gnome-calculator &

        uv run yarf --platform Mir --output-format TestSubmissionSchema tests/canary_test

    - name: Download test submission schema and validate
      run: |
        version=$(jq -r '.version' /tmp/yarf-outdir/TestSubmissionSchema_output.json)
        check-jsonschema --schemafile https://raw.githubusercontent.com/canonical/test-submission-schema/refs/heads/main/test_submission_schema/schemas/v${version}.json /tmp/yarf-outdir/TestSubmissionSchema_output.json

    - name: Install tutorial dependencies
      run: |
        sudo apt-get --yes --no-install-recommends install \
          python3-gi \
          gir1.2-gtk-4.0 \
          libadwaita-1-dev \
          gir1.2-adw-1

    - name: Run tutorial examples
      run: |
        export WAYLAND_DISPLAY=wayland-0

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-0\$" $XDG_RUNTIME_DIR

        uv venv --python=/usr/bin/python3 --system-site-packages --project=$(pwd)/examples/yarf-example-simple-counter
        dbus-run-session -- uv --project=$(pwd)/examples/yarf-example-simple-counter run simple-counter &

        uv run yarf --platform Mir examples/yarf-example-simple-counter/yarf_tests

        dbus-run-session -- uv --project=$(pwd)/examples/yarf-example-simple-counter run simple-counter --theme light &
        uv run yarf --platform Mir --variant light examples/yarf-example-simple-counter/yarf_tests

    - name: Install keyword suite dependencies
      run: |
        sudo apt-get --yes --no-install-recommends install \
          eog
        uv pip install asttokens

    - name: Run Keyword tests - VideoInput imaging
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        export WAYLAND_DISPLAY=wayland-1

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-1\$" $XDG_RUNTIME_DIR

        # Avoid GNOME apps waiting for portals
        dbus-run-session -- gnome-calculator &

        uv run yarf --platform Mir tests/keyword_suite -- --suite video_image_test --listener ${KEYWORDS_LISTENER_PATH}

    - name: Run Keyword tests - VideoInput text
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        export WAYLAND_DISPLAY=wayland-2

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-2\$" $XDG_RUNTIME_DIR

        # Avoid GNOME apps waiting for portals
        dbus-run-session -- eog -f tests/keyword_suite/text/text.png &

        uv run yarf --platform Mir tests/keyword_suite -- --suite video_text_test --listener ${KEYWORDS_LISTENER_PATH}

    - name: Run Keyword tests - VideoInput Video
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        # Use ffmpeg to generate a 30 secs video:
        ffmpeg -f lavfi -i testsrc=duration=30:size=1280x720:rate=30 -c:v libx264 test_video.mp4

        export WAYLAND_DISPLAY=wayland-3

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-3\$" $XDG_RUNTIME_DIR

        # Avoid GNOME apps waiting for portals
        dbus-run-session -- xdg-open test_video.mp4 &

        uv run yarf --platform Mir tests/keyword_suite -- --suite video_video_test --listener ${KEYWORDS_LISTENER_PATH}

    - name: Run Keyword tests - Hid keyboard
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        export WAYLAND_DISPLAY=wayland-4
        export WAYLAND_DEBUG=client

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-4\$" $XDG_RUNTIME_DIR

        uv run yarf --platform Mir tests/keyword_suite -- --suite hid_keyboard_test --listener ${KEYWORDS_LISTENER_PATH} 2> ~/wayland.trace

    - name: Run Keyword tests - Hid pointer
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        export WAYLAND_DISPLAY=wayland-5
        export WAYLAND_DEBUG=client

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-5\$" $XDG_RUNTIME_DIR

        uv run yarf --platform Mir tests/keyword_suite -- --suite hid_pointer_test --listener ${KEYWORDS_LISTENER_PATH} 2> ~/wayland.trace

    - name: Run Keyword tests - KVM
      env:
        KEYWORDS_LISTENER_PATH: .github/scripts/yarf/keywords_listener.py
      run: |
        export WAYLAND_DISPLAY=wayland-6
        export WAYLAND_DEBUG=client

        # Start Mir on a virtual display (doesn't require graphics hardware)
        mir-test-tools.demo-server \
          --add-wayland-extensions zwlr_screencopy_manager_v1:zwlr_virtual_pointer_manager_v1 \
          --platform-display-libs mir:virtual \
          --virtual-output 1280x1024 &

        # Wait for the compositor to start
        inotifywait --event create --include "^$XDG_RUNTIME_DIR/wayland-6\$" $XDG_RUNTIME_DIR

        dbus-run-session -- gnome-calculator &

        uv run yarf --platform Mir tests/keyword_suite -- --suite kvm_test --listener ${KEYWORDS_LISTENER_PATH} 2> ~/wayland.trace

    - name: Check Keywords coverage
      env:
        KEYWORDS_COVERAGE_CHECKER: .github/scripts/yarf/check_unused_keywords.py
      run: |
        pip install tabulate
        python3 ${KEYWORDS_COVERAGE_CHECKER}

    - if: failure()
      name: Collect test results
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: yarf-output
        path: /tmp/yarf-outdir/*
        retention-days: 5

    - if: failure() && runner.debug
      name: Setup upterm session (restart with "Enable debug logging" to activate)
      uses: canonical/action-tmate@a0e8caed3bba2ccb98901a274553bf1284ad96c2  # zizmor: ignore[stale-action-refs]
      with:
        limit-access-to-actor: true
